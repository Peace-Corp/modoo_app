# Client-Side SVG Export Implementation

## Overview

This document describes the implementation of client-side SVG export using Fabric.js's native `toSVG()` method. This replaces the previous server-side manual SVG construction approach with a more accurate and maintainable solution.

## Architecture

### 1. Export at Design Save Time

SVG exports are now generated **at the time a design is saved**, not when an order is created. This has several advantages:
- Access to actual Fabric.js canvas objects (can use `object.toSVG()`)
- More accurate SVG representation
- Faster order creation (no need to regenerate)
- Better error handling (user can retry if save fails)

### 2. Client-Side vs Server-Side

**Client-Side Export** (New - Primary):
- Uses Fabric.js `object.toSVG()` method
- Occurs in [lib/designService.ts](../lib/designService.ts) during `saveDesign()`
- Generates accurate SVG with proper transforms, fonts, and styling
- Uploads to Supabase Storage immediately

**Server-Side Export** (Fallback):
- Uses manual SVG construction from JSON state
- Occurs in [lib/server-svg-export.ts](../lib/server-svg-export.ts)
- Used only if pre-generated SVGs are not available
- Maintained for backward compatibility

## Implementation Details

### Modified Files

#### 1. [lib/designService.ts](../lib/designService.ts)

**Changes:**
- Added `canvasMap?: Record<string, fabric.Canvas>` to `SaveDesignData` interface
- Added `text_svg_exports?: TextSvgExports` to `SavedDesign` interface
- Modified `saveDesign()` to export SVGs using Fabric.js when canvas instances are provided

**Key Code:**
```typescript
// Export text objects to SVG using Fabric's toSVG() if canvas instances are provided
const textSvgExports: TextSvgExports = {};
if (data.canvasMap) {
  for (const [sideId, canvas] of Object.entries(data.canvasMap)) {
    const { objectSvgs } = extractTextObjectsToSVG(canvas);

    for (const objectSvg of objectSvgs) {
      const uploadResult = await uploadSVGToStorage(
        supabase,
        objectSvg.svg, // SVG generated by Fabric.js toSVG()
        STORAGE_BUCKETS.TEXT_EXPORTS,
        STORAGE_FOLDERS.SVG,
        fileName
      );

      if (uploadResult.success && uploadResult.url) {
        sideObjectUrls[objectSvg.objectId] = uploadResult.url;
      }
    }
  }
}
```

#### 2. [app/editor/[productId]/ProductEditorClientDesktop.tsx](../app/editor/[productId]/ProductEditorClientDesktop.tsx)

**Changes:**
- Pass `canvasMap` to `saveDesign()` call

**Before:**
```typescript
const savedDesign = await saveDesign({
  productId: product.id,
  title: designTitle.trim(),
  productColor: productColor,
  canvasState: canvasState,
  previewImage: previewImage,
  pricePerItem: pricePerItem,
});
```

**After:**
```typescript
const savedDesign = await saveDesign({
  productId: product.id,
  title: designTitle.trim(),
  productColor: productColor,
  canvasState: canvasState,
  previewImage: previewImage,
  pricePerItem: pricePerItem,
  canvasMap: canvasMap, // Pass canvas instances for client-side SVG export
});
```

#### 3. [app/editor/[productId]/ProductEditorClient.tsx](../app/editor/[productId]/ProductEditorClient.tsx)

Same changes as ProductEditorClientDesktop.tsx.

#### 4. Order Creation Routes

All three order creation routes have been updated to use pre-generated SVGs with fallback:

**a. [app/api/cobuy/create-order/route.ts](../app/api/cobuy/create-order/route.ts)**
- Added `text_svg_exports?: TextSvgExports` to `designSnapshot` type
- Uses pre-generated SVGs from CoBuy session's saved design

**b. [app/api/toss/confirm/route.ts](../app/api/toss/confirm/route.ts)**
- Added `text_svg_exports` to `savedDesignsMap` and `groupedItems` types
- Fetches `text_svg_exports` from saved_designs table
- Checks for pre-generated SVGs before creating new ones

**c. [app/api/checkout/testmode/route.ts](../app/api/checkout/testmode/route.ts)**
- Same changes as Toss payment route
- Used for test mode order creation

**Common Pattern:**
```typescript
// Check if the design already has pre-generated SVG exports (from client-side)
let svgUrls: TextSvgExports = {};
const hasPreGeneratedSvgs = correspondingGroup?.text_svg_exports &&
  typeof correspondingGroup.text_svg_exports === 'object' &&
  Object.keys(correspondingGroup.text_svg_exports).length > 0;

if (hasPreGeneratedSvgs) {
  // Use pre-generated SVGs from client-side export (uses Fabric.js toSVG())
  console.log('Using pre-generated client-side SVG exports');
  svgUrls = correspondingGroup!.text_svg_exports as TextSvgExports;
} else {
  // Fallback: Generate SVGs server-side from canvas state JSON
  console.log('No pre-generated SVGs found, generating server-side');
  svgUrls = await exportAndUploadTextFromCanvasState(
    supabase,
    canvasStateMap,
    item.id
  );
}
```

## Database Schema Changes

### Required Migration

Add `text_svg_exports` column to both tables:

```sql
-- Add text_svg_exports column to saved_designs table
ALTER TABLE saved_designs
ADD COLUMN IF NOT EXISTS text_svg_exports JSONB;

COMMENT ON COLUMN saved_designs.text_svg_exports IS 'Pre-generated SVG export URLs created during design save using Fabric.js toSVG()';

-- Add to saved_design_screenshots (used by CoBuy)
ALTER TABLE saved_design_screenshots
ADD COLUMN IF NOT EXISTS text_svg_exports JSONB;

COMMENT ON COLUMN saved_design_screenshots.text_svg_exports IS 'Pre-generated SVG export URLs created during design save using Fabric.js toSVG()';
```

### Data Format

The `text_svg_exports` field follows the `TextSvgExports` type:

```typescript
export type TextSvgObjectExports = Record<string, Record<string, string>>;
export interface TextSvgExports {
  __objects?: TextSvgObjectExports;
  [sideId: string]: string | TextSvgObjectExports | undefined;
}
```

Example:
```json
{
  "__objects": {
    "front": {
      "text-0": "https://storage.supabase.co/.../design-123-front-text-0.svg",
      "text-1": "https://storage.supabase.co/.../design-123-front-text-1.svg"
    },
    "back": {
      "text-0": "https://storage.supabase.co/.../design-123-back-text-0.svg"
    }
  }
}
```

## Advantages of Client-Side Export

1. **Accuracy**: Uses Fabric.js's native `toSVG()` method instead of manual SVG construction
2. **Maintainability**: Fabric.js handles complex transforms, fonts, and styling
3. **Performance**: SVGs are generated once at save time, not at every order creation
4. **Error Handling**: Users can retry if save fails; doesn't block order creation
5. **Compatibility**: Handles all Fabric.js object types and properties correctly

## Backward Compatibility

The implementation maintains backward compatibility:
- **Old designs** without `text_svg_exports` will use server-side generation
- **New designs** will use pre-generated client-side exports
- No data migration required
- Server-side code ([lib/server-svg-export.ts](../lib/server-svg-export.ts)) remains functional

## Testing Checklist

- [ ] Add `text_svg_exports` column to database via Supabase
- [ ] Create a new design with text objects
- [ ] Verify SVGs are uploaded to Supabase Storage during save
- [ ] Verify `text_svg_exports` field is populated in `saved_designs` table
- [ ] Create an order from the design
- [ ] Verify order creation uses pre-generated SVGs (check console logs)
- [ ] Test with old designs (should fallback to server-side generation)
- [ ] Verify SVG quality and accuracy compared to canvas display

## Related Files

**Client-Side:**
- [lib/canvas-svg-export.ts](../lib/canvas-svg-export.ts) - Client-side SVG extraction using Fabric.js `toSVG()`
- [lib/designService.ts](../lib/designService.ts) - Design save logic with SVG export
- [app/editor/[productId]/ProductEditorClient.tsx](../app/editor/[productId]/ProductEditorClient.tsx) - Mobile editor
- [app/editor/[productId]/ProductEditorClientDesktop.tsx](../app/editor/[productId]/ProductEditorClientDesktop.tsx) - Desktop editor

**Server-Side:**
- [lib/server-svg-export.ts](../lib/server-svg-export.ts) - Server-side fallback SVG generation
- [app/api/cobuy/create-order/route.ts](../app/api/cobuy/create-order/route.ts) - CoBuy order creation
- [app/api/toss/confirm/route.ts](../app/api/toss/confirm/route.ts) - Toss payment confirmation
- [app/api/checkout/testmode/route.ts](../app/api/checkout/testmode/route.ts) - Test mode checkout

**Documentation:**
- [docs/CLIENT_SIDE_SVG_EXPORT.md](../docs/CLIENT_SIDE_SVG_EXPORT.md) - This file
- [docs/RETRIEVING_ORDER_SVG_FILES.md](../docs/RETRIEVING_ORDER_SVG_FILES.md) - Guide to accessing SVG files from orders
- [docs/SVG_EXPORT_MIGRATION_SUMMARY.md](../docs/SVG_EXPORT_MIGRATION_SUMMARY.md) - Migration summary
- [docs/SVG_EXPORT_FIX_SUMMARY.md](../docs/SVG_EXPORT_FIX_SUMMARY.md) - Previous server-side implementation
